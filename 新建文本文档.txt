//@version=5
indicator("Pinbar Detector", overlay=true)

// Input parameters
length = input.int(14, title="Lookback Period", minval=1)
bodyPercent = input.float(30.0, title="Max Body Percentage", minval=1, maxval=100) / 100
wickPercent = input.float(70.0, title="Min Wick Percentage", minval=1, maxval=100) / 100
showLabels = input.bool(true, title="Show Labels")
showArrows = input.bool(true, title="Show Arrows")

// Calculate candle components
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
totalRange = high - low

// Pinbar conditions
isPinbar = false
isBullishPinbar = false
isBearishPinbar = false

if totalRange > 0
    bodyRatio = bodySize / totalRange
    upperWickRatio = upperWick / totalRange
    lowerWickRatio = lowerWick / totalRange
    
    // Bullish pinbar (hammer-like)
    isBullishPinbar := lowerWickRatio >= wickPercent and bodyRatio <= bodyPercent and close > open
    
    // Bearish pinbar (shooting star-like)
    isBearishPinbar := upperWickRatio >= wickPercent and bodyRatio <= bodyPercent and close < open
    
    isPinbar := isBullishPinbar or isBearishPinbar

// Plotting
plotshape(isBullishPinbar and showArrows, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="Bullish Pinbar")
plotshape(isBearishPinbar and showArrows, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, title="Bearish Pinbar")

if showLabels and isPinbar
    label.new(bar_index, isBullishPinbar ? low : high, 
              text=isBullishPinbar ? "Bull Pin" : "Bear Pin", 
              style=isBullishPinbar ? label.style_label_up : label.style_label_down,
              color=isBullishPinbar ? color.green : color.red,
              textcolor=color.white,
              yloc=isBullishPinbar ? yloc.belowbar : yloc.abovebar)

// Optional: Background highlight for pinbars
bgcolor(isPinbar ? color.new(isBullishPinbar ? color.green : color.red, 90) : na)